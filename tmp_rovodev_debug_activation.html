<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡å¡å•Ÿç”¨èª¿è©¦å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .debug-section h3 {
            color: #333;
            margin-top: 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 12px;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æœƒå“¡å¡å•Ÿç”¨èª¿è©¦å·¥å…·</h1>
        
        <div class="debug-section">
            <h3>ğŸ” 1. ç™»å…¥ç‹€æ…‹æª¢æŸ¥</h3>
            <button onclick="checkLoginStatus()">æª¢æŸ¥ç™»å…¥ç‹€æ…‹</button>
            <button onclick="loginTestUser()">ç™»å…¥æ¸¬è©¦ç”¨æˆ¶ (user2@example.com)</button>
            <div id="loginStatus" class="result" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ“Š 2. Dashboard è³‡æ–™æª¢æŸ¥</h3>
            <button onclick="checkDashboardData()">ç²å– Dashboard è³‡æ–™</button>
            <button onclick="checkMembershipData()">æª¢æŸ¥æœƒå“¡è³‡æ ¼è³‡æ–™</button>
            <div id="dashboardData" class="result" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ¯ 3. æœƒå“¡å¡å•Ÿç”¨æ¸¬è©¦</h3>
            <button onclick="testActivation()">æ¸¬è©¦å•Ÿç”¨ (æœƒå“¡å¡ ID: 2)</button>
            <button onclick="testActivationWithDebug()">è©³ç´°èª¿è©¦å•Ÿç”¨</button>
            <div id="activationTest" class="result" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ—ƒï¸ 4. è³‡æ–™åº«ç‹€æ…‹æª¢æŸ¥</h3>
            <button onclick="checkAllMemberships()">æŸ¥çœ‹æ‰€æœ‰æœƒå“¡è³‡æ ¼</button>
            <button onclick="checkAllUsers()">æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ¶</button>
            <div id="databaseData" class="result" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ”„ 5. é‡ç½®æ¸¬è©¦è³‡æ–™</h3>
            <button class="danger" onclick="resetTestData()">é‡ç½®æœƒå“¡å¡ç‹€æ…‹ç‚º PURCHASED</button>
            <div id="resetResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let currentToken = null;
        let currentUserId = null;

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = content;
            element.style.display = 'block';
        }

        function checkLoginStatus() {
            showResult('loginStatus', 'ğŸ” æª¢æŸ¥ç™»å…¥ç‹€æ…‹...', 'info');
            
            const token = localStorage.getItem('jwt');
            if (!token) {
                showResult('loginStatus', 'âŒ æœªæ‰¾åˆ° JWT token\nè«‹å…ˆç™»å…¥æ¸¬è©¦å¸³è™Ÿ', 'error');
                return;
            }

            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentToken = token;
                currentUserId = payload.userId;
                
                const result = `âœ… å·²ç™»å…¥
ç”¨æˆ¶ ID: ${payload.userId}
ç”¨æˆ¶ Email: ${payload.email}
ç”¨æˆ¶è§’è‰²: ${payload.role}
Token: ${token.substring(0, 50)}...`;
                
                showResult('loginStatus', result, 'success');
            } catch (error) {
                showResult('loginStatus', `âŒ è§£æ JWT token å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function loginTestUser() {
            showResult('loginStatus', 'â³ ç™»å…¥æ¸¬è©¦ç”¨æˆ¶...', 'info');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'user2@example.com',
                        password: 'password'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentToken = result.jwt;
                    currentUserId = result.user_id;
                    localStorage.setItem('jwt', result.jwt);
                    
                    showResult('loginStatus', `âœ… ç™»å…¥æˆåŠŸï¼
ç”¨æˆ¶ ID: ${result.user_id}
JWT Token: ${result.jwt.substring(0, 50)}...`, 'success');
                } else {
                    showResult('loginStatus', `âŒ ç™»å…¥å¤±æ•—: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('loginStatus', `âŒ ç™»å…¥éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function checkDashboardData() {
            if (!currentToken) {
                showResult('dashboardData', 'âŒ è«‹å…ˆç™»å…¥', 'error');
                return;
            }

            showResult('dashboardData', 'â³ ç²å– Dashboard è³‡æ–™...', 'info');
            
            // é€™è£¡æ¨¡æ“¬ Dashboard è³‡æ–™ç²å–
            // å¯¦éš›ä¸Šæ‡‰è©²å‘¼å« dashboardService.getDashboardData()
            showResult('dashboardData', `ğŸ“Š Dashboard è³‡æ–™æª¢æŸ¥
ç•¶å‰ç”¨æˆ¶ ID: ${currentUserId}

ğŸ’¡ å»ºè­°æª¢æŸ¥é …ç›®:
1. ç”¨æˆ¶æ˜¯å¦æœ‰æœƒå“¡è³‡æ ¼è¨˜éŒ„
2. æœƒå“¡è³‡æ ¼ç‹€æ…‹æ˜¯å¦ç‚º PURCHASED
3. æœƒå“¡è³‡æ ¼çš„ user_id æ˜¯å¦åŒ¹é…ç•¶å‰ç”¨æˆ¶

è«‹æŸ¥çœ‹ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·çš„ Console æ—¥èªŒç²å–æ›´å¤šè©³ç´°è³‡è¨Š`, 'info');
        }

        async function checkMembershipData() {
            if (!currentToken) {
                showResult('dashboardData', 'âŒ è«‹å…ˆç™»å…¥', 'error');
                return;
            }

            showResult('dashboardData', 'â³ æª¢æŸ¥æœƒå“¡è³‡æ ¼è³‡æ–™...', 'info');
            
            // æ¨¡æ“¬æª¢æŸ¥æœƒå“¡è³‡æ ¼
            const expectedMembership = {
                id: 2,
                user_id: 2,
                status: 'PURCHASED',
                duration_in_days: 90
            };

            showResult('dashboardData', `ğŸ¯ é æœŸçš„æœƒå“¡è³‡æ ¼è³‡æ–™:
ID: ${expectedMembership.id}
ç”¨æˆ¶ ID: ${expectedMembership.user_id}
ç‹€æ…‹: ${expectedMembership.status}
æœŸé™: ${expectedMembership.duration_in_days} å¤©

ç•¶å‰ç”¨æˆ¶ ID: ${currentUserId}
åŒ¹é…ç‹€æ…‹: ${currentUserId === expectedMembership.user_id ? 'âœ… åŒ¹é…' : 'âŒ ä¸åŒ¹é…'}`, 'info');
        }

        async function testActivation() {
            if (!currentToken) {
                showResult('activationTest', 'âŒ è«‹å…ˆç™»å…¥', 'error');
                return;
            }

            showResult('activationTest', 'â³ æ¸¬è©¦æœƒå“¡å¡å•Ÿç”¨...', 'info');
            
            try {
                const response = await fetch('/api/member-cards/2/activate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                const result = await response.json();
                
                const output = `ğŸ“¡ API æ¸¬è©¦çµæœ:
è«‹æ±‚ URL: /api/member-cards/2/activate
è«‹æ±‚æ–¹æ³•: POST
ç‹€æ…‹ç¢¼: ${response.status}

å›æ‡‰å…§å®¹:
${JSON.stringify(result, null, 2)}

${result.success ? 'âœ… å•Ÿç”¨æˆåŠŸ' : 'âŒ å•Ÿç”¨å¤±æ•—'}
${result.error ? `éŒ¯èª¤: ${result.error}` : ''}
${result.message ? `è¨Šæ¯: ${result.message}` : ''}`;

                const type = result.success ? 'success' : 'error';
                showResult('activationTest', output, type);
            } catch (error) {
                showResult('activationTest', `âŒ API è«‹æ±‚éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testActivationWithDebug() {
            if (!currentToken) {
                showResult('activationTest', 'âŒ è«‹å…ˆç™»å…¥', 'error');
                return;
            }

            showResult('activationTest', 'â³ è©³ç´°èª¿è©¦å•Ÿç”¨éç¨‹...', 'info');
            
            // é–‹å•Ÿ Console ç›£è½
            console.log('ğŸ” é–‹å§‹è©³ç´°èª¿è©¦æœƒå“¡å¡å•Ÿç”¨');
            console.log('ç•¶å‰ç”¨æˆ¶ ID:', currentUserId);
            console.log('å˜—è©¦å•Ÿç”¨æœƒå“¡å¡ ID: 2');
            
            try {
                const response = await fetch('/api/member-cards/2/activate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                const result = await response.json();
                console.log('API å›æ‡‰:', result);
                
                showResult('activationTest', `ğŸ” è©³ç´°èª¿è©¦å®Œæˆ
è«‹æŸ¥çœ‹ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·çš„ Console æ¨™ç±¤é 
æŸ¥çœ‹è©³ç´°çš„èª¿è©¦æ—¥èªŒ

API å›æ‡‰æ‘˜è¦:
ç‹€æ…‹: ${response.status}
æˆåŠŸ: ${result.success}
éŒ¯èª¤: ${result.error || 'ç„¡'}

ğŸ’¡ å¦‚æœçœ‹åˆ° "æ‰¾ä¸åˆ°å¯å•Ÿç”¨çš„æœƒå“¡å¡" éŒ¯èª¤:
1. æª¢æŸ¥ç”¨æˆ¶ ID æ˜¯å¦æ­£ç¢º
2. æª¢æŸ¥æœƒå“¡è³‡æ ¼è³‡æ–™æ˜¯å¦å­˜åœ¨
3. æª¢æŸ¥æœƒå“¡å¡ç‹€æ…‹æ˜¯å¦ç‚º PURCHASED`, 'warning');
            } catch (error) {
                showResult('activationTest', `âŒ èª¿è©¦éç¨‹éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function checkAllMemberships() {
            showResult('databaseData', 'ğŸ“‹ æ¨¡æ“¬æœƒå“¡è³‡æ ¼è³‡æ–™...', 'info');
            
            const mockMemberships = [
                { id: 1, user_id: 1, status: 'ACTIVE', duration_in_days: 90 },
                { id: 2, user_id: 2, status: 'PURCHASED', duration_in_days: 90 },
                { id: 3, user_id: 3, status: 'ACTIVE', duration_in_days: 90 }
            ];

            let table = `ğŸ“Š æ‰€æœ‰æœƒå“¡è³‡æ ¼è³‡æ–™:

ID | ç”¨æˆ¶ID | ç‹€æ…‹      | æœŸé™(å¤©)
---|--------|-----------|----------`;

            mockMemberships.forEach(m => {
                table += `\n${m.id}  | ${m.user_id}      | ${m.status.padEnd(9)} | ${m.duration_in_days}`;
            });

            table += `\n\nç•¶å‰ç”¨æˆ¶ ID: ${currentUserId || 'æœªç™»å…¥'}
åŒ¹é…çš„æœƒå“¡è³‡æ ¼: ${mockMemberships.find(m => m.user_id === currentUserId) ? 'âœ… æ‰¾åˆ°' : 'âŒ æœªæ‰¾åˆ°'}`;

            showResult('databaseData', table, 'info');
        }

        async function checkAllUsers() {
            showResult('databaseData', 'ğŸ‘¥ æ¨¡æ“¬ç”¨æˆ¶è³‡æ–™...', 'info');
            
            const mockUsers = [
                { id: 1, email: 'alice@example.com', name: 'Alice Wang' },
                { id: 2, email: 'user2@example.com', name: 'Bob Chen' },
                { id: 3, email: 'charlie@example.com', name: 'Charlie Lin' },
                { id: 8, email: 'david@example.com', name: 'David Wilson' }
            ];

            let table = `ğŸ‘¥ æ‰€æœ‰ç”¨æˆ¶è³‡æ–™:

ID | Email                | å§“å
---|----------------------|-------------`;

            mockUsers.forEach(u => {
                table += `\n${u.id}  | ${u.email.padEnd(20)} | ${u.name}`;
            });

            table += `\n\nç•¶å‰ç”¨æˆ¶ ID: ${currentUserId || 'æœªç™»å…¥'}
ç•¶å‰ç”¨æˆ¶: ${mockUsers.find(u => u.id === currentUserId)?.name || 'æœªæ‰¾åˆ°'}`;

            showResult('databaseData', table, 'info');
        }

        async function resetTestData() {
            showResult('resetResult', 'âš ï¸ é€™æ˜¯æ¨¡æ“¬é‡ç½®ï¼Œå¯¦éš›è³‡æ–™åœ¨è¨˜æ†¶é«”ä¸­', 'warning');
            
            setTimeout(() => {
                showResult('resetResult', `âœ… æ¨¡æ“¬é‡ç½®å®Œæˆ
æœƒå“¡å¡ ID 2 çš„ç‹€æ…‹å·²é‡ç½®ç‚º PURCHASED

ğŸ’¡ å¯¦éš›é‡ç½®éœ€è¦:
1. é‡æ–°å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨
2. æˆ–å¯¦ç¾è³‡æ–™é‡ç½® API`, 'success');
            }, 1000);
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        window.onload = function() {
            console.log('ğŸš€ æœƒå“¡å¡å•Ÿç”¨èª¿è©¦å·¥å…·å·²è¼‰å…¥');
            checkLoginStatus();
        };
    </script>
</body>
</html>