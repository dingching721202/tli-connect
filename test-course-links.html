<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦èª²ç¨‹é€£çµåŠŸèƒ½</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .success {
            background: #28a745;
        }
        .success:hover {
            background: #1e7e34;
        }
        .warning {
            background: #ffc107;
            color: #212529;
        }
        .warning:hover {
            background: #e0a800;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 20px;
            margin: 20px 0;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .result.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .link-button {
            display: inline-block;
            padding: 8px 16px;
            margin: 5px;
            background: #17a2b8;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }
        .link-button:hover {
            background: #138496;
        }
        .link-button.disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— èª²ç¨‹é€£çµåŠŸèƒ½æ¸¬è©¦</h1>
        
        <div class="test-section">
            <h2>ğŸš€ å¿«é€Ÿæ¸¬è©¦</h2>
            <button class="button success" onclick="runQuickTest()">åŸ·è¡Œå¿«é€Ÿæ¸¬è©¦</button>
            <button class="button" onclick="testPronunciation()">æ¸¬è©¦ Pronunciation èª²ç¨‹</button>
            <button class="button" onclick="testAllCourses()">æ¸¬è©¦æ‰€æœ‰èª²ç¨‹</button>
            <button class="button warning" onclick="setupPronunciation()">è¨­ç½® Pronunciation è³‡æ–™</button>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“‹ æ‰‹å‹•æ¸¬è©¦</h2>
            <div>
                <label>èª²ç¨‹åç¨±ï¼š</label>
                <input type="text" id="courseName" value="Pronunciation - Lesson 1 - Pronunciation of Consonant & Vowel" style="width: 400px; padding: 8px; margin: 5px;">
            </div>
            <button class="button" onclick="testCourseName()">æ¸¬è©¦é€™å€‹èª²ç¨‹</button>
        </div>
        
        <div id="results" class="test-section" style="display: none;">
            <h2>ğŸ“Š æ¸¬è©¦çµæœ</h2>
            <div id="resultsContent"></div>
        </div>
        
        <div id="logs" class="log">æº–å‚™åŸ·è¡Œæ¸¬è©¦...</div>
    </div>

    <script>
        const logElement = document.getElementById('logs');
        const resultsElement = document.getElementById('results');
        const resultsContent = document.getElementById('resultsContent');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            logElement.textContent = '';
            resultsElement.style.display = 'none';
        }
        
        function showResults(content) {
            resultsContent.innerHTML = content;
            resultsElement.style.display = 'block';
        }
        
        // èª²ç¨‹é€£çµæŸ¥æ‰¾å‡½æ•¸ï¼ˆæ¨¡æ“¬ï¼‰
        function getCourseLinksFromTemplate(courseName, lessonNumber) {
            log(`ğŸ” æŸ¥æ‰¾èª²ç¨‹é€£çµ: ${courseName} - Lesson ${lessonNumber}`);
            
            const templates = JSON.parse(localStorage.getItem('courseTemplates') || '[]');
            log(`ğŸ“š ç¸½å…±æœ‰ ${templates.length} å€‹èª²ç¨‹æ¨¡æ¿`);
            
            // æŸ¥æ‰¾å°æ‡‰çš„æ¨¡æ¿
            const courseTemplate = templates.find(template => {
                const templateTitle = template.title.toLowerCase();
                const searchName = courseName.toLowerCase();
                
                if (templateTitle === searchName) return true;
                if (templateTitle.includes(searchName) || searchName.includes(templateTitle)) return true;
                
                const normalizedTemplate = templateTitle.replace(/\\s+/g, '');
                const normalizedSearch = searchName.replace(/\\s+/g, '');
                if (normalizedTemplate === normalizedSearch) return true;
                
                return false;
            });
            
            if (!courseTemplate) {
                log(`âŒ æœªæ‰¾åˆ°èª²ç¨‹æ¨¡æ¿: ${courseName}`);
                log('å¯ç”¨çš„èª²ç¨‹æ¨¡æ¿: ' + templates.map(t => t.title).join(', '));
                return { classroom: null, materials: null };
            }
            
            log(`âœ… æ‰¾åˆ°èª²ç¨‹æ¨¡æ¿: ${courseTemplate.title}`);
            
            // æŸ¥æ‰¾å°æ‡‰çš„Session
            const session = courseTemplate.sessions.find(s => s.sessionNumber === lessonNumber);
            
            if (!session) {
                log(`âŒ åœ¨èª²ç¨‹ ${courseTemplate.title} ä¸­æœªæ‰¾åˆ° Lesson ${lessonNumber}`);
                log('å¯ç”¨çš„Lesson: ' + courseTemplate.sessions.map(s => `Lesson ${s.sessionNumber}: ${s.title}`).join(', '));
                return { classroom: null, materials: null };
            }
            
            log(`âœ… æ‰¾åˆ°èª²ç¨‹Session: Lesson ${session.sessionNumber} - ${session.title}`);
            
            // ç²å–é€£çµï¼Œè™•ç†çµ±ä¸€è¨­å®šå›é€€
            let classroom = session.virtualClassroomLink;
            let materials = session.materialLink;
            
            // è™•ç†çµ±ä¸€è¨­å®šå›é€€
            if (!classroom || classroom.trim() === '') {
                if (courseTemplate.globalSettings?.defaultVirtualClassroomLink) {
                    classroom = courseTemplate.globalSettings.defaultVirtualClassroomLink;
                    log(`ğŸ“ ä½¿ç”¨çµ±ä¸€è™›æ“¬æ•™å®¤è¨­å®š: ${classroom}`);
                } else {
                    log(`âš ï¸ Session ${lessonNumber} æ²’æœ‰è™›æ“¬æ•™å®¤é€£çµï¼Œä¸”æ²’æœ‰çµ±ä¸€è¨­å®š`);
                }
            }
            
            if (!materials || materials.trim() === '') {
                if (courseTemplate.globalSettings?.defaultMaterialLink) {
                    materials = courseTemplate.globalSettings.defaultMaterialLink;
                    log(`ğŸ“„ ä½¿ç”¨çµ±ä¸€æ•™æè¨­å®š: ${materials}`);
                } else {
                    log(`âš ï¸ Session ${lessonNumber} æ²’æœ‰æ•™æé€£çµï¼Œä¸”æ²’æœ‰çµ±ä¸€è¨­å®š`);
                }
            }
            
            log(`ğŸ”— æœ€çµ‚é€£çµ: æ•™å®¤=${classroom || 'ç„¡'}, æ•™æ=${materials || 'ç„¡'}`);
            
            return {
                classroom: classroom || null,
                materials: materials || null
            };
        }
        
        function parseCourseNameAndLesson(fullCourseName) {
            log(`ğŸ” è§£æèª²ç¨‹åç¨±: ${fullCourseName}`);
            
            const patterns = [
                /^(.+?)\\s*-\\s*Lesson\\s+(\\d+)\\s*-\\s*.+$/i,
                /^(.+?)\\s+Lesson\\s+(\\d+)\\s*-\\s*.+$/i,
                /^(.+?)\\s*-\\s*Lesson\\s+(\\d+)$/i,
                /^(.+?)\\s+Lesson\\s+(\\d+)$/i
            ];
            
            for (const pattern of patterns) {
                const match = fullCourseName.match(pattern);
                if (match) {
                    const courseName = match[1].trim();
                    const lessonNumber = parseInt(match[2], 10);
                    
                    log(`âœ… è§£ææˆåŠŸ: èª²ç¨‹=${courseName}, Lesson=${lessonNumber}`);
                    return { courseName, lessonNumber };
                }
            }
            
            log(`âŒ ç„¡æ³•è§£æèª²ç¨‹åç¨±: ${fullCourseName}`);
            return null;
        }
        
        function getCourseLinksFromFullName(fullCourseName) {
            const parsed = parseCourseNameAndLesson(fullCourseName);
            
            if (!parsed) {
                log(`ç„¡æ³•è§£æèª²ç¨‹åç¨±ï¼Œè¿”å›ç©ºé€£çµ: ${fullCourseName}`);
                return { classroom: null, materials: null };
            }
            
            return getCourseLinksFromTemplate(parsed.courseName, parsed.lessonNumber);
        }
        
        function isValidLink(link) {
            if (!link || link.trim() === '') return false;
            
            try {
                if (link.startsWith('http://') || link.startsWith('https://')) {
                    new URL(link);
                    return true;
                }
                
                if (link.startsWith('/') || link.startsWith('./') || link.startsWith('../')) {
                    return true;
                }
                
                if (link.includes('.')) {
                    return true;
                }
                
                return false;
            } catch {
                return false;
            }
        }
        
        function getValidCourseLinks(fullCourseName) {
            const links = getCourseLinksFromFullName(fullCourseName);
            
            return {
                classroom: isValidLink(links.classroom) ? links.classroom : null,
                materials: isValidLink(links.materials) ? links.materials : null,
                hasValidClassroom: isValidLink(links.classroom),
                hasValidMaterials: isValidLink(links.materials)
            };
        }
        
        // æ¸¬è©¦å‡½æ•¸
        function runQuickTest() {
            clearLogs();
            log('ğŸš€ åŸ·è¡Œå¿«é€Ÿæ¸¬è©¦...');
            
            const testCourses = [
                'Pronunciation - Lesson 1 - Pronunciation of Consonant & Vowel',
                'Pronunciation - Lesson 2 - Stress and Rhythm',
                'Pronunciation - Lesson 3 - Intonation Patterns', // é€™å€‹æ‡‰è©²ä½¿ç”¨çµ±ä¸€è¨­å®š
                'Pronunciation - Lesson 4 - Connected Speech'
            ];
            
            let results = '';
            
            testCourses.forEach(courseName => {
                log(`\\n=== æ¸¬è©¦: ${courseName} ===`);
                const links = getValidCourseLinks(courseName);
                
                const hasClassroom = links.hasValidClassroom;
                const hasMaterials = links.hasValidMaterials;
                
                results += `
                    <div class="result ${hasClassroom && hasMaterials ? 'success' : hasClassroom || hasMaterials ? 'warning' : 'error'}">
                        <strong>${courseName}</strong><br>
                        æ•™å®¤é€£çµ: ${hasClassroom ? 'âœ…' : 'âŒ'} ${links.classroom || 'ç„¡'}<br>
                        æ•™æé€£çµ: ${hasMaterials ? 'âœ…' : 'âŒ'} ${links.materials || 'ç„¡'}
                        ${hasClassroom ? `<a href="${links.classroom}" target="_blank" class="link-button">æ¸¬è©¦æ•™å®¤é€£çµ</a>` : ''}
                        ${hasMaterials ? `<a href="${links.materials}" target="_blank" class="link-button">æ¸¬è©¦æ•™æé€£çµ</a>` : ''}
                    </div>
                `;
            });
            
            showResults(results);
            log('âœ… å¿«é€Ÿæ¸¬è©¦å®Œæˆ');
        }
        
        function testPronunciation() {
            clearLogs();
            log('ğŸ¯ å°ˆé–€æ¸¬è©¦ Pronunciation èª²ç¨‹...');
            
            const templates = JSON.parse(localStorage.getItem('courseTemplates') || '[]');
            const pronunciationTemplate = templates.find(t => t.title.toLowerCase().includes('pronunciation'));
            
            if (!pronunciationTemplate) {
                log('âŒ æœªæ‰¾åˆ° Pronunciation èª²ç¨‹æ¨¡æ¿');
                log('è«‹å…ˆåŸ·è¡Œ"è¨­ç½® Pronunciation è³‡æ–™"');
                return;
            }
            
            log(`âœ… æ‰¾åˆ° Pronunciation æ¨¡æ¿: ${pronunciationTemplate.title}`);
            log(`ğŸ“š ç¸½èª²ç¨‹æ•¸: ${pronunciationTemplate.totalSessions}`);
            log(`ğŸŒ çµ±ä¸€è¨­å®š:`, JSON.stringify(pronunciationTemplate.globalSettings, null, 2));
            
            let results = '';
            
            pronunciationTemplate.sessions.forEach(session => {
                const fullCourseName = `${pronunciationTemplate.title} - Lesson ${session.sessionNumber} - ${session.title}`;
                const links = getValidCourseLinks(fullCourseName);
                
                log(`\\n--- Lesson ${session.sessionNumber} ---`);
                log(`èª²ç¨‹: ${session.title}`);
                log(`åŸå§‹è™›æ“¬æ•™å®¤: ${session.virtualClassroomLink || '(ç©ºç™½)'}`);
                log(`åŸå§‹æ•™æ: ${session.materialLink || '(ç©ºç™½)'}`);
                log(`æœ€çµ‚æ•™å®¤é€£çµ: ${links.classroom || 'ç„¡'}`);
                log(`æœ€çµ‚æ•™æé€£çµ: ${links.materials || 'ç„¡'}`);
                
                const hasClassroom = links.hasValidClassroom;
                const hasMaterials = links.hasValidMaterials;
                
                results += `
                    <div class="result ${hasClassroom && hasMaterials ? 'success' : hasClassroom || hasMaterials ? 'warning' : 'error'}">
                        <strong>Lesson ${session.sessionNumber}: ${session.title}</strong><br>
                        åŸå§‹æ•™å®¤: ${session.virtualClassroomLink || '(ç©ºç™½)'}<br>
                        åŸå§‹æ•™æ: ${session.materialLink || '(ç©ºç™½)'}<br>
                        æœ€çµ‚æ•™å®¤: ${hasClassroom ? 'âœ…' : 'âŒ'} ${links.classroom || 'ç„¡'}<br>
                        æœ€çµ‚æ•™æ: ${hasMaterials ? 'âœ…' : 'âŒ'} ${links.materials || 'ç„¡'}
                        ${hasClassroom ? `<a href="${links.classroom}" target="_blank" class="link-button">æ¸¬è©¦æ•™å®¤</a>` : ''}
                        ${hasMaterials ? `<a href="${links.materials}" target="_blank" class="link-button">æ¸¬è©¦æ•™æ</a>` : ''}
                    </div>
                `;
            });
            
            showResults(results);
            log('âœ… Pronunciation æ¸¬è©¦å®Œæˆ');
        }
        
        function testAllCourses() {
            clearLogs();
            log('ğŸ” æ¸¬è©¦æ‰€æœ‰èª²ç¨‹æ¨¡æ¿...');
            
            const templates = JSON.parse(localStorage.getItem('courseTemplates') || '[]');
            
            if (templates.length === 0) {
                log('âŒ æ²’æœ‰æ‰¾åˆ°ä»»ä½•èª²ç¨‹æ¨¡æ¿');
                return;
            }
            
            let results = '';
            
            templates.forEach(template => {
                log(`\\n=== èª²ç¨‹: ${template.title} ===`);
                
                template.sessions.forEach(session => {
                    const fullCourseName = `${template.title} - Lesson ${session.sessionNumber} - ${session.title}`;
                    const links = getValidCourseLinks(fullCourseName);
                    
                    const hasClassroom = links.hasValidClassroom;
                    const hasMaterials = links.hasValidMaterials;
                    
                    results += `
                        <div class="result ${hasClassroom && hasMaterials ? 'success' : hasClassroom || hasMaterials ? 'warning' : 'error'}">
                            <strong>${template.title} - Lesson ${session.sessionNumber}</strong><br>
                            ${session.title}<br>
                            æ•™å®¤: ${hasClassroom ? 'âœ…' : 'âŒ'} ${links.classroom || 'ç„¡'}<br>
                            æ•™æ: ${hasMaterials ? 'âœ…' : 'âŒ'} ${links.materials || 'ç„¡'}
                            ${hasClassroom ? `<a href="${links.classroom}" target="_blank" class="link-button">æ¸¬è©¦æ•™å®¤</a>` : ''}
                            ${hasMaterials ? `<a href="${links.materials}" target="_blank" class="link-button">æ¸¬è©¦æ•™æ</a>` : ''}
                        </div>
                    `;
                });
            });
            
            showResults(results);
            log('âœ… æ‰€æœ‰èª²ç¨‹æ¸¬è©¦å®Œæˆ');
        }
        
        function testCourseName() {
            const courseName = document.getElementById('courseName').value;
            if (!courseName.trim()) {
                alert('è«‹è¼¸å…¥èª²ç¨‹åç¨±');
                return;
            }
            
            clearLogs();
            log(`ğŸ” æ¸¬è©¦æŒ‡å®šèª²ç¨‹: ${courseName}`);
            
            const links = getValidCourseLinks(courseName);
            
            const hasClassroom = links.hasValidClassroom;
            const hasMaterials = links.hasValidMaterials;
            
            const results = `
                <div class="result ${hasClassroom && hasMaterials ? 'success' : hasClassroom || hasMaterials ? 'warning' : 'error'}">
                    <strong>${courseName}</strong><br>
                    æ•™å®¤é€£çµ: ${hasClassroom ? 'âœ…' : 'âŒ'} ${links.classroom || 'ç„¡'}<br>
                    æ•™æé€£çµ: ${hasMaterials ? 'âœ…' : 'âŒ'} ${links.materials || 'ç„¡'}
                    ${hasClassroom ? `<a href="${links.classroom}" target="_blank" class="link-button">æ¸¬è©¦æ•™å®¤é€£çµ</a>` : ''}
                    ${hasMaterials ? `<a href="${links.materials}" target="_blank" class="link-button">æ¸¬è©¦æ•™æé€£çµ</a>` : ''}
                </div>
            `;
            
            showResults(results);
            log('âœ… æŒ‡å®šèª²ç¨‹æ¸¬è©¦å®Œæˆ');
        }
        
        function setupPronunciation() {
            // è·³è½‰åˆ°è¨­ç½®é é¢
            window.open('setup-pronunciation.html', '_blank');
        }
    </script>
</body>
</html>