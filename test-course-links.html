<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>測試課程連結功能</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .success {
            background: #28a745;
        }
        .success:hover {
            background: #1e7e34;
        }
        .warning {
            background: #ffc107;
            color: #212529;
        }
        .warning:hover {
            background: #e0a800;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 20px;
            margin: 20px 0;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .result.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .link-button {
            display: inline-block;
            padding: 8px 16px;
            margin: 5px;
            background: #17a2b8;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }
        .link-button:hover {
            background: #138496;
        }
        .link-button.disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔗 課程連結功能測試</h1>
        
        <div class="test-section">
            <h2>🚀 快速測試</h2>
            <button class="button success" onclick="runQuickTest()">執行快速測試</button>
            <button class="button" onclick="testPronunciation()">測試 Pronunciation 課程</button>
            <button class="button" onclick="testAllCourses()">測試所有課程</button>
            <button class="button warning" onclick="setupPronunciation()">設置 Pronunciation 資料</button>
        </div>
        
        <div class="test-section">
            <h2>📋 手動測試</h2>
            <div>
                <label>課程名稱：</label>
                <input type="text" id="courseName" value="Pronunciation - Lesson 1 - Pronunciation of Consonant & Vowel" style="width: 400px; padding: 8px; margin: 5px;">
            </div>
            <button class="button" onclick="testCourseName()">測試這個課程</button>
        </div>
        
        <div id="results" class="test-section" style="display: none;">
            <h2>📊 測試結果</h2>
            <div id="resultsContent"></div>
        </div>
        
        <div id="logs" class="log">準備執行測試...</div>
    </div>

    <script>
        const logElement = document.getElementById('logs');
        const resultsElement = document.getElementById('results');
        const resultsContent = document.getElementById('resultsContent');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            logElement.textContent = '';
            resultsElement.style.display = 'none';
        }
        
        function showResults(content) {
            resultsContent.innerHTML = content;
            resultsElement.style.display = 'block';
        }
        
        // 課程連結查找函數（模擬）
        function getCourseLinksFromTemplate(courseName, lessonNumber) {
            log(`🔍 查找課程連結: ${courseName} - Lesson ${lessonNumber}`);
            
            const templates = JSON.parse(localStorage.getItem('courseTemplates') || '[]');
            log(`📚 總共有 ${templates.length} 個課程模板`);
            
            // 查找對應的模板
            const courseTemplate = templates.find(template => {
                const templateTitle = template.title.toLowerCase();
                const searchName = courseName.toLowerCase();
                
                if (templateTitle === searchName) return true;
                if (templateTitle.includes(searchName) || searchName.includes(templateTitle)) return true;
                
                const normalizedTemplate = templateTitle.replace(/\\s+/g, '');
                const normalizedSearch = searchName.replace(/\\s+/g, '');
                if (normalizedTemplate === normalizedSearch) return true;
                
                return false;
            });
            
            if (!courseTemplate) {
                log(`❌ 未找到課程模板: ${courseName}`);
                log('可用的課程模板: ' + templates.map(t => t.title).join(', '));
                return { classroom: null, materials: null };
            }
            
            log(`✅ 找到課程模板: ${courseTemplate.title}`);
            
            // 查找對應的Session
            const session = courseTemplate.sessions.find(s => s.sessionNumber === lessonNumber);
            
            if (!session) {
                log(`❌ 在課程 ${courseTemplate.title} 中未找到 Lesson ${lessonNumber}`);
                log('可用的Lesson: ' + courseTemplate.sessions.map(s => `Lesson ${s.sessionNumber}: ${s.title}`).join(', '));
                return { classroom: null, materials: null };
            }
            
            log(`✅ 找到課程Session: Lesson ${session.sessionNumber} - ${session.title}`);
            
            // 獲取連結，處理統一設定回退
            let classroom = session.virtualClassroomLink;
            let materials = session.materialLink;
            
            // 處理統一設定回退
            if (!classroom || classroom.trim() === '') {
                if (courseTemplate.globalSettings?.defaultVirtualClassroomLink) {
                    classroom = courseTemplate.globalSettings.defaultVirtualClassroomLink;
                    log(`📍 使用統一虛擬教室設定: ${classroom}`);
                } else {
                    log(`⚠️ Session ${lessonNumber} 沒有虛擬教室連結，且沒有統一設定`);
                }
            }
            
            if (!materials || materials.trim() === '') {
                if (courseTemplate.globalSettings?.defaultMaterialLink) {
                    materials = courseTemplate.globalSettings.defaultMaterialLink;
                    log(`📄 使用統一教材設定: ${materials}`);
                } else {
                    log(`⚠️ Session ${lessonNumber} 沒有教材連結，且沒有統一設定`);
                }
            }
            
            log(`🔗 最終連結: 教室=${classroom || '無'}, 教材=${materials || '無'}`);
            
            return {
                classroom: classroom || null,
                materials: materials || null
            };
        }
        
        function parseCourseNameAndLesson(fullCourseName) {
            log(`🔍 解析課程名稱: ${fullCourseName}`);
            
            const patterns = [
                /^(.+?)\\s*-\\s*Lesson\\s+(\\d+)\\s*-\\s*.+$/i,
                /^(.+?)\\s+Lesson\\s+(\\d+)\\s*-\\s*.+$/i,
                /^(.+?)\\s*-\\s*Lesson\\s+(\\d+)$/i,
                /^(.+?)\\s+Lesson\\s+(\\d+)$/i
            ];
            
            for (const pattern of patterns) {
                const match = fullCourseName.match(pattern);
                if (match) {
                    const courseName = match[1].trim();
                    const lessonNumber = parseInt(match[2], 10);
                    
                    log(`✅ 解析成功: 課程=${courseName}, Lesson=${lessonNumber}`);
                    return { courseName, lessonNumber };
                }
            }
            
            log(`❌ 無法解析課程名稱: ${fullCourseName}`);
            return null;
        }
        
        function getCourseLinksFromFullName(fullCourseName) {
            const parsed = parseCourseNameAndLesson(fullCourseName);
            
            if (!parsed) {
                log(`無法解析課程名稱，返回空連結: ${fullCourseName}`);
                return { classroom: null, materials: null };
            }
            
            return getCourseLinksFromTemplate(parsed.courseName, parsed.lessonNumber);
        }
        
        function isValidLink(link) {
            if (!link || link.trim() === '') return false;
            
            try {
                if (link.startsWith('http://') || link.startsWith('https://')) {
                    new URL(link);
                    return true;
                }
                
                if (link.startsWith('/') || link.startsWith('./') || link.startsWith('../')) {
                    return true;
                }
                
                if (link.includes('.')) {
                    return true;
                }
                
                return false;
            } catch {
                return false;
            }
        }
        
        function getValidCourseLinks(fullCourseName) {
            const links = getCourseLinksFromFullName(fullCourseName);
            
            return {
                classroom: isValidLink(links.classroom) ? links.classroom : null,
                materials: isValidLink(links.materials) ? links.materials : null,
                hasValidClassroom: isValidLink(links.classroom),
                hasValidMaterials: isValidLink(links.materials)
            };
        }
        
        // 測試函數
        function runQuickTest() {
            clearLogs();
            log('🚀 執行快速測試...');
            
            const testCourses = [
                'Pronunciation - Lesson 1 - Pronunciation of Consonant & Vowel',
                'Pronunciation - Lesson 2 - Stress and Rhythm',
                'Pronunciation - Lesson 3 - Intonation Patterns', // 這個應該使用統一設定
                'Pronunciation - Lesson 4 - Connected Speech'
            ];
            
            let results = '';
            
            testCourses.forEach(courseName => {
                log(`\\n=== 測試: ${courseName} ===`);
                const links = getValidCourseLinks(courseName);
                
                const hasClassroom = links.hasValidClassroom;
                const hasMaterials = links.hasValidMaterials;
                
                results += `
                    <div class="result ${hasClassroom && hasMaterials ? 'success' : hasClassroom || hasMaterials ? 'warning' : 'error'}">
                        <strong>${courseName}</strong><br>
                        教室連結: ${hasClassroom ? '✅' : '❌'} ${links.classroom || '無'}<br>
                        教材連結: ${hasMaterials ? '✅' : '❌'} ${links.materials || '無'}
                        ${hasClassroom ? `<a href="${links.classroom}" target="_blank" class="link-button">測試教室連結</a>` : ''}
                        ${hasMaterials ? `<a href="${links.materials}" target="_blank" class="link-button">測試教材連結</a>` : ''}
                    </div>
                `;
            });
            
            showResults(results);
            log('✅ 快速測試完成');
        }
        
        function testPronunciation() {
            clearLogs();
            log('🎯 專門測試 Pronunciation 課程...');
            
            const templates = JSON.parse(localStorage.getItem('courseTemplates') || '[]');
            const pronunciationTemplate = templates.find(t => t.title.toLowerCase().includes('pronunciation'));
            
            if (!pronunciationTemplate) {
                log('❌ 未找到 Pronunciation 課程模板');
                log('請先執行"設置 Pronunciation 資料"');
                return;
            }
            
            log(`✅ 找到 Pronunciation 模板: ${pronunciationTemplate.title}`);
            log(`📚 總課程數: ${pronunciationTemplate.totalSessions}`);
            log(`🌐 統一設定:`, JSON.stringify(pronunciationTemplate.globalSettings, null, 2));
            
            let results = '';
            
            pronunciationTemplate.sessions.forEach(session => {
                const fullCourseName = `${pronunciationTemplate.title} - Lesson ${session.sessionNumber} - ${session.title}`;
                const links = getValidCourseLinks(fullCourseName);
                
                log(`\\n--- Lesson ${session.sessionNumber} ---`);
                log(`課程: ${session.title}`);
                log(`原始虛擬教室: ${session.virtualClassroomLink || '(空白)'}`);
                log(`原始教材: ${session.materialLink || '(空白)'}`);
                log(`最終教室連結: ${links.classroom || '無'}`);
                log(`最終教材連結: ${links.materials || '無'}`);
                
                const hasClassroom = links.hasValidClassroom;
                const hasMaterials = links.hasValidMaterials;
                
                results += `
                    <div class="result ${hasClassroom && hasMaterials ? 'success' : hasClassroom || hasMaterials ? 'warning' : 'error'}">
                        <strong>Lesson ${session.sessionNumber}: ${session.title}</strong><br>
                        原始教室: ${session.virtualClassroomLink || '(空白)'}<br>
                        原始教材: ${session.materialLink || '(空白)'}<br>
                        最終教室: ${hasClassroom ? '✅' : '❌'} ${links.classroom || '無'}<br>
                        最終教材: ${hasMaterials ? '✅' : '❌'} ${links.materials || '無'}
                        ${hasClassroom ? `<a href="${links.classroom}" target="_blank" class="link-button">測試教室</a>` : ''}
                        ${hasMaterials ? `<a href="${links.materials}" target="_blank" class="link-button">測試教材</a>` : ''}
                    </div>
                `;
            });
            
            showResults(results);
            log('✅ Pronunciation 測試完成');
        }
        
        function testAllCourses() {
            clearLogs();
            log('🔍 測試所有課程模板...');
            
            const templates = JSON.parse(localStorage.getItem('courseTemplates') || '[]');
            
            if (templates.length === 0) {
                log('❌ 沒有找到任何課程模板');
                return;
            }
            
            let results = '';
            
            templates.forEach(template => {
                log(`\\n=== 課程: ${template.title} ===`);
                
                template.sessions.forEach(session => {
                    const fullCourseName = `${template.title} - Lesson ${session.sessionNumber} - ${session.title}`;
                    const links = getValidCourseLinks(fullCourseName);
                    
                    const hasClassroom = links.hasValidClassroom;
                    const hasMaterials = links.hasValidMaterials;
                    
                    results += `
                        <div class="result ${hasClassroom && hasMaterials ? 'success' : hasClassroom || hasMaterials ? 'warning' : 'error'}">
                            <strong>${template.title} - Lesson ${session.sessionNumber}</strong><br>
                            ${session.title}<br>
                            教室: ${hasClassroom ? '✅' : '❌'} ${links.classroom || '無'}<br>
                            教材: ${hasMaterials ? '✅' : '❌'} ${links.materials || '無'}
                            ${hasClassroom ? `<a href="${links.classroom}" target="_blank" class="link-button">測試教室</a>` : ''}
                            ${hasMaterials ? `<a href="${links.materials}" target="_blank" class="link-button">測試教材</a>` : ''}
                        </div>
                    `;
                });
            });
            
            showResults(results);
            log('✅ 所有課程測試完成');
        }
        
        function testCourseName() {
            const courseName = document.getElementById('courseName').value;
            if (!courseName.trim()) {
                alert('請輸入課程名稱');
                return;
            }
            
            clearLogs();
            log(`🔍 測試指定課程: ${courseName}`);
            
            const links = getValidCourseLinks(courseName);
            
            const hasClassroom = links.hasValidClassroom;
            const hasMaterials = links.hasValidMaterials;
            
            const results = `
                <div class="result ${hasClassroom && hasMaterials ? 'success' : hasClassroom || hasMaterials ? 'warning' : 'error'}">
                    <strong>${courseName}</strong><br>
                    教室連結: ${hasClassroom ? '✅' : '❌'} ${links.classroom || '無'}<br>
                    教材連結: ${hasMaterials ? '✅' : '❌'} ${links.materials || '無'}
                    ${hasClassroom ? `<a href="${links.classroom}" target="_blank" class="link-button">測試教室連結</a>` : ''}
                    ${hasMaterials ? `<a href="${links.materials}" target="_blank" class="link-button">測試教材連結</a>` : ''}
                </div>
            `;
            
            showResults(results);
            log('✅ 指定課程測試完成');
        }
        
        function setupPronunciation() {
            // 跳轉到設置頁面
            window.open('setup-pronunciation.html', '_blank');
        }
    </script>
</body>
</html>