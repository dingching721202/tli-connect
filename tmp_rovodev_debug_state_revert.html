<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡å¡ç‹€æ…‹å›é€€å•é¡Œèª¿è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .debug-section h3 {
            color: #333;
            margin-top: 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .timeline {
            border-left: 3px solid #007bff;
            padding-left: 20px;
            margin: 20px 0;
        }
        .timeline-item {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .timestamp {
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æœƒå“¡å¡ç‹€æ…‹å›é€€å•é¡Œèª¿è©¦</h1>
        <p><strong>å•é¡Œï¼š</strong> æœƒå“¡å¡å•Ÿç”¨å¾Œå¹¾ç§’é˜åˆè‡ªå‹•è®Šå›æœªå•Ÿç”¨ç‹€æ…‹</p>
        
        <div class="debug-section">
            <h3>ğŸ¯ å•é¡Œåˆ†æ</h3>
            <p>å¯èƒ½çš„åŸå› ï¼š</p>
            <ul>
                <li>1. æœ¬åœ°ç‹€æ…‹æ›´æ–°å¾Œï¼Œå¾Œç«¯é‡æ–°è¼‰å…¥è¦†è“‹äº†æœ¬åœ°ç‹€æ…‹</li>
                <li>2. å¾Œç«¯è³‡æ–™æ²’æœ‰æ­£ç¢ºä¿å­˜å•Ÿç”¨ç‹€æ…‹</li>
                <li>3. Dashboard é‡æ–°è¼‰å…¥æ™‚æŸ¥æ‰¾é‚è¼¯æœ‰å•é¡Œ</li>
                <li>4. è¨˜æ†¶é«”ä¸­çš„è³‡æ–™è¢«é‡ç½®</li>
            </ul>
        </div>

        <div class="debug-section">
            <h3>ğŸ” 1. ç™»å…¥ä¸¦æº–å‚™æ¸¬è©¦</h3>
            <button onclick="loginAndPrepare()">ç™»å…¥æ¸¬è©¦å¸³è™Ÿ</button>
            <div id="loginResult" class="result" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ“Š 2. ç›£æ§ç‹€æ…‹è®ŠåŒ–</h3>
            <button onclick="startMonitoring()">é–‹å§‹ç›£æ§æœƒå“¡å¡ç‹€æ…‹</button>
            <button onclick="stopMonitoring()">åœæ­¢ç›£æ§</button>
            <div id="monitoringResult" class="result" style="display: none;"></div>
            <div id="timeline" class="timeline" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸš€ 3. åŸ·è¡Œå•Ÿç”¨ä¸¦è§€å¯Ÿ</h3>
            <button onclick="activateAndObserve()">å•Ÿç”¨æœƒå“¡å¡ä¸¦è§€å¯Ÿç‹€æ…‹è®ŠåŒ–</button>
            <div id="activationResult" class="result" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ” 4. æª¢æŸ¥å¾Œç«¯è³‡æ–™</h3>
            <button onclick="checkBackendData()">æª¢æŸ¥å¾Œç«¯æœƒå“¡è³‡æ ¼è³‡æ–™</button>
            <button onclick="simulateDataReload()">æ¨¡æ“¬è³‡æ–™é‡æ–°è¼‰å…¥</button>
            <div id="backendResult" class="result" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ› ï¸ 5. ä¿®å¾©æ¸¬è©¦</h3>
            <button onclick="testFix()">æ¸¬è©¦ä¿®å¾©æ–¹æ¡ˆ</button>
            <div id="fixResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let currentToken = null;
        let currentUserId = null;
        let monitoringInterval = null;
        let stateHistory = [];

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = content;
            element.style.display = 'block';
        }

        function addToTimeline(event, status) {
            const timeline = document.getElementById('timeline');
            timeline.style.display = 'block';
            
            const timestamp = new Date().toLocaleTimeString();
            const item = document.createElement('div');
            item.className = 'timeline-item';
            item.innerHTML = `
                <div class="timestamp">${timestamp}</div>
                <div>${event}</div>
                <div>ç‹€æ…‹: ${status}</div>
            `;
            timeline.appendChild(item);
            
            // ä¿æŒæœ€æ–°çš„10å€‹äº‹ä»¶
            if (timeline.children.length > 10) {
                timeline.removeChild(timeline.firstChild);
            }
            
            // æ»¾å‹•åˆ°æœ€æ–°äº‹ä»¶
            timeline.scrollTop = timeline.scrollHeight;
        }

        async function loginAndPrepare() {
            showResult('loginResult', 'â³ ç™»å…¥æ¸¬è©¦å¸³è™Ÿ...', 'info');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'user2@example.com',
                        password: 'password'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentToken = result.jwt;
                    currentUserId = result.user_id;
                    localStorage.setItem('jwt', result.jwt);
                    
                    showResult('loginResult', `âœ… ç™»å…¥æˆåŠŸï¼
ç”¨æˆ¶ ID: ${result.user_id}
æº–å‚™é–‹å§‹èª¿è©¦ç‹€æ…‹å›é€€å•é¡Œ`, 'success');
                    
                    addToTimeline('ç”¨æˆ¶ç™»å…¥æˆåŠŸ', `ç”¨æˆ¶ ID: ${result.user_id}`);
                } else {
                    showResult('loginResult', `âŒ ç™»å…¥å¤±æ•—: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('loginResult', `âŒ ç™»å…¥éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        function startMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            showResult('monitoringResult', 'ğŸ” é–‹å§‹ç›£æ§æœƒå“¡å¡ç‹€æ…‹è®ŠåŒ–...', 'info');
            addToTimeline('é–‹å§‹ç›£æ§ç‹€æ…‹', 'æ¯2ç§’æª¢æŸ¥ä¸€æ¬¡');
            
            monitoringInterval = setInterval(async () => {
                try {
                    // é€™è£¡æ‡‰è©²å‘¼å«å¯¦éš›çš„ Dashboard API
                    // ç›®å‰æ¨¡æ“¬ç›£æ§
                    const timestamp = new Date().toLocaleTimeString();
                    console.log(`[${timestamp}] ç›£æ§ä¸­...`);
                    
                    // æ¨¡æ“¬ç‹€æ…‹æª¢æŸ¥
                    addToTimeline('ç‹€æ…‹æª¢æŸ¥', 'ç›£æ§ä¸­...');
                    
                } catch (error) {
                    console.error('ç›£æ§éŒ¯èª¤:', error);
                }
            }, 2000);
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                showResult('monitoringResult', 'â¹ï¸ ç›£æ§å·²åœæ­¢', 'warning');
                addToTimeline('åœæ­¢ç›£æ§', 'ç›£æ§çµæŸ');
            }
        }

        async function activateAndObserve() {
            if (!currentToken) {
                showResult('activationResult', 'âŒ è«‹å…ˆç™»å…¥', 'error');
                return;
            }

            showResult('activationResult', 'ğŸš€ é–‹å§‹å•Ÿç”¨æœƒå“¡å¡ä¸¦è§€å¯Ÿç‹€æ…‹è®ŠåŒ–...', 'info');
            addToTimeline('é–‹å§‹å•Ÿç”¨æœƒå“¡å¡', 'PURCHASED â†’ ACTIVE');
            
            try {
                // æ­¥é©Ÿ 1: å•Ÿç”¨æœƒå“¡å¡
                console.log('ğŸš€ æ­¥é©Ÿ 1: å•Ÿç”¨æœƒå“¡å¡');
                const response = await fetch('/api/member-cards/2/activate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                const result = await response.json();
                addToTimeline('API å•Ÿç”¨å›æ‡‰', `æˆåŠŸ: ${result.success}`);
                
                if (result.success) {
                    // æ­¥é©Ÿ 2: ç«‹å³æª¢æŸ¥ç‹€æ…‹
                    console.log('ğŸ” æ­¥é©Ÿ 2: ç«‹å³æª¢æŸ¥ç‹€æ…‹');
                    addToTimeline('ç«‹å³æª¢æŸ¥ç‹€æ…‹', 'å•Ÿç”¨å¾Œ0ç§’');
                    
                    // æ­¥é©Ÿ 3: ç­‰å¾…1ç§’å¾Œæª¢æŸ¥
                    setTimeout(() => {
                        console.log('ğŸ” æ­¥é©Ÿ 3: 1ç§’å¾Œæª¢æŸ¥ç‹€æ…‹');
                        addToTimeline('1ç§’å¾Œæª¢æŸ¥ç‹€æ…‹', 'æª¢æŸ¥æ˜¯å¦ä¿æŒ ACTIVE');
                    }, 1000);
                    
                    // æ­¥é©Ÿ 4: ç­‰å¾…3ç§’å¾Œæª¢æŸ¥
                    setTimeout(() => {
                        console.log('ğŸ” æ­¥é©Ÿ 4: 3ç§’å¾Œæª¢æŸ¥ç‹€æ…‹');
                        addToTimeline('3ç§’å¾Œæª¢æŸ¥ç‹€æ…‹', 'æª¢æŸ¥æ˜¯å¦å›é€€');
                    }, 3000);
                    
                    // æ­¥é©Ÿ 5: ç­‰å¾…5ç§’å¾Œæª¢æŸ¥
                    setTimeout(() => {
                        console.log('ğŸ” æ­¥é©Ÿ 5: 5ç§’å¾Œæª¢æŸ¥ç‹€æ…‹');
                        addToTimeline('5ç§’å¾Œæª¢æŸ¥ç‹€æ…‹', 'æœ€çµ‚ç‹€æ…‹ç¢ºèª');
                    }, 5000);
                    
                    showResult('activationResult', `âœ… å•Ÿç”¨æˆåŠŸï¼Œæ­£åœ¨è§€å¯Ÿç‹€æ…‹è®ŠåŒ–...
è«‹æŸ¥çœ‹æ™‚é–“è»¸å’Œ Console æ—¥èªŒ
è§€å¯Ÿæœƒå“¡å¡ç‹€æ…‹æ˜¯å¦åœ¨å¹¾ç§’å¾Œå›é€€`, 'success');
                } else {
                    showResult('activationResult', `âŒ å•Ÿç”¨å¤±æ•—: ${result.error}`, 'error');
                    addToTimeline('å•Ÿç”¨å¤±æ•—', result.error);
                }
            } catch (error) {
                showResult('activationResult', `âŒ å•Ÿç”¨éŒ¯èª¤: ${error.message}`, 'error');
                addToTimeline('å•Ÿç”¨éŒ¯èª¤', error.message);
            }
        }

        async function checkBackendData() {
            showResult('backendResult', 'ğŸ” æª¢æŸ¥å¾Œç«¯æœƒå“¡è³‡æ ¼è³‡æ–™...', 'info');
            
            // æ¨¡æ“¬æª¢æŸ¥å¾Œç«¯è³‡æ–™
            const mockData = `ğŸ“Š æ¨¡æ“¬å¾Œç«¯æœƒå“¡è³‡æ ¼è³‡æ–™æª¢æŸ¥:

æœƒå“¡è³‡æ ¼ ID: 2
ç”¨æˆ¶ ID: 2
ç‹€æ…‹: ${Math.random() > 0.5 ? 'ACTIVE' : 'PURCHASED'}
å•Ÿç”¨æ™‚é–“: ${new Date().toISOString()}
åˆ°æœŸæ™‚é–“: ${new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString()}

ğŸ’¡ é—œéµæª¢æŸ¥é»:
1. å•Ÿç”¨å¾Œç‹€æ…‹æ˜¯å¦æ­£ç¢ºä¿å­˜ç‚º ACTIVE
2. è¨˜æ†¶é«”ä¸­çš„è³‡æ–™æ˜¯å¦è¢«æ„å¤–é‡ç½®
3. getDashboardData æ˜¯å¦æ­£ç¢ºæŸ¥æ‰¾ ACTIVE æœƒå“¡å¡`;

            showResult('backendResult', mockData, 'info');
            addToTimeline('æª¢æŸ¥å¾Œç«¯è³‡æ–™', 'è³‡æ–™ç‹€æ…‹æª¢æŸ¥');
        }

        async function simulateDataReload() {
            showResult('backendResult', 'ğŸ”„ æ¨¡æ“¬è³‡æ–™é‡æ–°è¼‰å…¥...', 'info');
            addToTimeline('æ¨¡æ“¬è³‡æ–™é‡æ–°è¼‰å…¥', 'æ¸¬è©¦é‡æ–°è¼‰å…¥é‚è¼¯');
            
            setTimeout(() => {
                const reloadResult = `ğŸ”„ è³‡æ–™é‡æ–°è¼‰å…¥å®Œæˆ

æ¨¡æ“¬ getDashboardData åŸ·è¡Œéç¨‹:
1. æŸ¥æ‰¾ ACTIVE æœƒå“¡å¡ â†’ ${Math.random() > 0.3 ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}
2. æŸ¥æ‰¾ PURCHASED æœƒå“¡å¡ â†’ ${Math.random() > 0.7 ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}
3. æœ€çµ‚è¿”å›çš„æœƒå“¡å¡ç‹€æ…‹ â†’ ${Math.random() > 0.5 ? 'ACTIVE' : 'PURCHASED'}

âš ï¸ å¦‚æœé‡æ–°è¼‰å…¥å¾Œç‹€æ…‹å›é€€ï¼Œå•é¡Œå¯èƒ½åœ¨æ–¼:
- å•Ÿç”¨å¾Œçš„è³‡æ–™æ²’æœ‰æ­£ç¢ºä¿å­˜
- æŸ¥æ‰¾é‚è¼¯æœ‰å•é¡Œ
- è¨˜æ†¶é«”è³‡æ–™è¢«é‡ç½®`;

                showResult('backendResult', reloadResult, 'warning');
                addToTimeline('é‡æ–°è¼‰å…¥å®Œæˆ', 'æª¢æŸ¥çµæœ');
            }, 1000);
        }

        async function testFix() {
            showResult('fixResult', 'ğŸ› ï¸ æ¸¬è©¦ä¿®å¾©æ–¹æ¡ˆ...', 'info');
            
            const fixSuggestions = `ğŸ› ï¸ ä¿®å¾©æ–¹æ¡ˆå»ºè­°:

1. æª¢æŸ¥ activateMemberCard å‡½æ•¸
   - ç¢ºä¿ç‹€æ…‹æ­£ç¢ºæ›´æ–°ç‚º ACTIVE
   - ç¢ºä¿è³‡æ–™æ­£ç¢ºä¿å­˜åœ¨è¨˜æ†¶é«”ä¸­

2. æª¢æŸ¥ getDashboardData å‡½æ•¸
   - ç¢ºä¿å„ªå…ˆæŸ¥æ‰¾ ACTIVE æœƒå“¡å¡
   - ç¢ºä¿æŸ¥æ‰¾é‚è¼¯æ­£ç¢º

3. æª¢æŸ¥å‰ç«¯ç‹€æ…‹æ›´æ–°
   - ç§»é™¤å»¶é²é‡æ–°è¼‰å…¥é‚è¼¯
   - æˆ–ç¢ºä¿é‡æ–°è¼‰å…¥ä¸æœƒè¦†è“‹æ­£ç¢ºç‹€æ…‹

4. æ·»åŠ æ›´å¤šèª¿è©¦æ—¥èªŒ
   - åœ¨é—œéµä½ç½®æ·»åŠ  console.log
   - è¿½è¹¤ç‹€æ…‹è®ŠåŒ–çš„å®Œæ•´æµç¨‹

ğŸ¯ ç«‹å³ä¿®å¾©å»ºè­°:
- æª¢æŸ¥ setTimeout å»¶é²è¼‰å…¥æ˜¯å¦å°è‡´ç‹€æ…‹å›é€€
- ç¢ºä¿å¾Œç«¯å•Ÿç”¨é‚è¼¯æ­£ç¢ºåŸ·è¡Œ
- é©—è­‰è¨˜æ†¶é«”è³‡æ–™æŒä¹…æ€§`;

            showResult('fixResult', fixSuggestions, 'warning');
            addToTimeline('ä¿®å¾©æ–¹æ¡ˆ', 'æä¾›ä¿®å¾©å»ºè­°');
        }

        // é é¢è¼‰å…¥æ™‚çš„èªªæ˜
        window.onload = function() {
            console.log('ğŸ” æœƒå“¡å¡ç‹€æ…‹å›é€€å•é¡Œèª¿è©¦å·¥å…·å·²è¼‰å…¥');
            console.log('è«‹æŒ‰é †åºåŸ·è¡Œèª¿è©¦æ­¥é©Ÿï¼Œè§€å¯Ÿç‹€æ…‹è®ŠåŒ–');
        };

        // é é¢å¸è¼‰æ™‚æ¸…ç†
        window.onbeforeunload = function() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
        };
    </script>
</body>
</html>