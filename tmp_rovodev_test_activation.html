<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡å¡å•Ÿç”¨åŠŸèƒ½æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            color: #333;
            margin-top: 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .user-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .login-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ æœƒå“¡å¡å•Ÿç”¨åŠŸèƒ½æ¸¬è©¦ (User Story 04)</h1>
        
        <div class="login-section">
            <h3>ğŸ” ç™»å…¥æ¸¬è©¦å¸³è™Ÿ</h3>
            <p>è«‹å…ˆç™»å…¥æœ‰ PURCHASED ç‹€æ…‹æœƒå“¡å¡çš„æ¸¬è©¦å¸³è™Ÿï¼š</p>
            <button onclick="loginTestUser()">ç™»å…¥æ¸¬è©¦ç”¨æˆ¶ (user2@example.com)</button>
            <div id="loginResult" class="result" style="display: none;"></div>
        </div>

        <div class="user-info">
            <h3>ğŸ“‹ æ¸¬è©¦è³‡æ–™èªªæ˜</h3>
            <ul>
                <li><strong>User ID 1 (alice@example.com):</strong> å·²æœ‰ ACTIVE æœƒå“¡å¡</li>
                <li><strong>User ID 2 (user2@example.com):</strong> æœ‰ PURCHASED æœƒå“¡å¡ (ç”¨æ–¼æ¸¬è©¦æ­£å¸¸å•Ÿç”¨)</li>
                <li><strong>User ID 3 (charlie@example.com):</strong> å·²æœ‰ ACTIVE æœƒå“¡å¡</li>
                <li><strong>User ID 8 (david@example.com):</strong> å®Œå…¨æ²’æœ‰æœƒå“¡å¡ (ç”¨æ–¼æ¸¬è©¦è³¼è²·æµç¨‹)</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ†• æ¸¬è©¦æ¡ˆä¾‹ 0: æ²’æœ‰æœƒå“¡å¡çš„ç”¨æˆ¶</h3>
            <p>æ¸¬è©¦å®Œå…¨æ²’æœ‰æœƒå“¡å¡çš„ç”¨æˆ¶çœ‹åˆ°çš„ç•Œé¢</p>
            <button onclick="loginNoMembershipUser()">ç™»å…¥ç„¡æœƒå“¡å¡ç”¨æˆ¶ (david@example.com)</button>
            <div id="result0" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>âœ… æ¸¬è©¦æ¡ˆä¾‹ 1: æ­£å¸¸å•Ÿç”¨æœƒå“¡å¡</h3>
            <p>ä½¿ç”¨ User ID 2 (PURCHASED ç‹€æ…‹) å•Ÿç”¨æœƒå“¡å¡</p>
            <button onclick="testNormalActivation()">åŸ·è¡Œæ¸¬è©¦</button>
            <div id="result1" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>âŒ æ¸¬è©¦æ¡ˆä¾‹ 2: é‡è¤‡å•Ÿç”¨æª¢æŸ¥</h3>
            <p>ä½¿ç”¨å·²æœ‰ ACTIVE æœƒå“¡å¡çš„ç”¨æˆ¶å˜—è©¦å•Ÿç”¨</p>
            <button onclick="testDuplicateActivation()">åŸ·è¡Œæ¸¬è©¦</button>
            <div id="result2" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ” æ¸¬è©¦æ¡ˆä¾‹ 3: æŸ¥çœ‹ Dashboard</h3>
            <p>æª¢æŸ¥ Dashboard ä¸­æœƒå“¡å¡çš„é¡¯ç¤ºç‹€æ…‹</p>
            <button onclick="openDashboard()">é–‹å•Ÿ Dashboard</button>
            <div id="result3" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æ¸¬è©¦æ¡ˆä¾‹ 4: ç²å–æœƒå“¡è³‡æ–™</h3>
            <p>æŸ¥çœ‹ç•¶å‰ç”¨æˆ¶çš„æœƒå“¡è³‡æ–™</p>
            <button onclick="getMembershipData()">ç²å–æœƒå“¡è³‡æ–™</button>
            <div id="result4" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let currentToken = null;
        let currentUserId = null;

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = content;
            element.style.display = 'block';
        }

        async function loginTestUser() {
            showResult('loginResult', 'â³ ç™»å…¥ä¸­...', 'info');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'user2@example.com',
                        password: 'password'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentToken = result.jwt;
                    currentUserId = result.user_id;
                    localStorage.setItem('jwt', result.jwt);
                    
                    showResult('loginResult', `âœ… ç™»å…¥æˆåŠŸï¼
ç”¨æˆ¶ ID: ${result.user_id}
Token: ${result.jwt.substring(0, 20)}...`, 'success');
                } else {
                    showResult('loginResult', `âŒ ç™»å…¥å¤±æ•—: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('loginResult', `âŒ ç™»å…¥éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function loginNoMembershipUser() {
            showResult('result0', 'â³ ç™»å…¥ç„¡æœƒå“¡å¡ç”¨æˆ¶...', 'info');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'david@example.com',
                        password: 'password'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentToken = result.jwt;
                    currentUserId = result.user_id;
                    localStorage.setItem('jwt', result.jwt);
                    
                    showResult('result0', `âœ… ç™»å…¥æˆåŠŸï¼
ç”¨æˆ¶: david@example.com (User ID: ${result.user_id})
ç‹€æ…‹: å®Œå…¨æ²’æœ‰æœƒå“¡å¡

ğŸ’¡ ç¾åœ¨å¯ä»¥ï¼š
1. é–‹å•Ÿ Dashboard æŸ¥çœ‹ã€Œå°šæœªè³¼è²·æœƒå“¡æ–¹æ¡ˆã€æç¤º
2. é»æ“Šã€Œè³¼è²·æœƒå“¡æ–¹æ¡ˆã€æŒ‰éˆ•æ¸¬è©¦è·³è½‰`, 'success');
                } else {
                    showResult('result0', `âŒ ç™»å…¥å¤±æ•—: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('result0', `âŒ ç™»å…¥éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testNormalActivation() {
            if (!currentToken) {
                showResult('result1', 'âŒ è«‹å…ˆç™»å…¥æ¸¬è©¦å¸³è™Ÿ', 'error');
                return;
            }

            showResult('result1', 'â³ åŸ·è¡Œæœƒå“¡å¡å•Ÿç”¨...', 'info');
            
            try {
                const response = await fetch('/api/member-cards/2/activate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                const result = await response.json();
                
                const output = `è«‹æ±‚: POST /api/member-cards/2/activate
ç‹€æ…‹ç¢¼: ${response.status}
å›æ‡‰å…§å®¹:
${JSON.stringify(result, null, 2)}`;

                const type = result.success ? 'success' : 'error';
                showResult('result1', output, type);
            } catch (error) {
                showResult('result1', `âŒ è«‹æ±‚éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testDuplicateActivation() {
            if (!currentToken) {
                showResult('result2', 'âŒ è«‹å…ˆç™»å…¥æ¸¬è©¦å¸³è™Ÿ', 'error');
                return;
            }

            showResult('result2', 'â³ æ¸¬è©¦é‡è¤‡å•Ÿç”¨...', 'info');
            
            try {
                // å…ˆå˜—è©¦å•Ÿç”¨ä¸€æ¬¡
                await fetch('/api/member-cards/2/activate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                // å†æ¬¡å˜—è©¦å•Ÿç”¨ (æ‡‰è©²å¤±æ•—)
                const response = await fetch('/api/member-cards/2/activate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                const result = await response.json();
                
                const output = `é‡è¤‡å•Ÿç”¨æ¸¬è©¦:
ç‹€æ…‹ç¢¼: ${response.status}
å›æ‡‰å…§å®¹:
${JSON.stringify(result, null, 2)}

${result.error === 'ACTIVE_CARD_EXISTS' ? 'âœ… æ­£ç¢ºé˜»æ­¢é‡è¤‡å•Ÿç”¨' : 'âŒ æœªæ­£ç¢ºè™•ç†é‡è¤‡å•Ÿç”¨'}`;

                const type = result.error === 'ACTIVE_CARD_EXISTS' ? 'success' : 'error';
                showResult('result2', output, type);
            } catch (error) {
                showResult('result2', `âŒ è«‹æ±‚éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function openDashboard() {
            if (!currentToken) {
                showResult('result3', 'âŒ è«‹å…ˆç™»å…¥æ¸¬è©¦å¸³è™Ÿ', 'error');
                return;
            }

            showResult('result3', 'ğŸš€ é–‹å•Ÿ Dashboard...', 'info');
            window.open('/dashboard', '_blank');
        }

        async function getMembershipData() {
            if (!currentToken) {
                showResult('result4', 'âŒ è«‹å…ˆç™»å…¥æ¸¬è©¦å¸³è™Ÿ', 'error');
                return;
            }

            showResult('result4', 'â³ ç²å–æœƒå“¡è³‡æ–™...', 'info');
            
            try {
                // é€™è£¡å¯ä»¥æ·»åŠ ç²å–æœƒå“¡è³‡æ–™çš„ API å‘¼å«
                // ç›®å‰å…ˆé¡¯ç¤ºæç¤ºè¨Šæ¯
                showResult('result4', `ğŸ’¡ è«‹åœ¨ Dashboard ä¸­æŸ¥çœ‹æœƒå“¡å¡ç‹€æ…‹
æˆ–åœ¨ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ä¸­æª¢æŸ¥ç¶²è·¯è«‹æ±‚`, 'info');
            } catch (error) {
                showResult('result4', `âŒ éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        // é é¢è¼‰å…¥æ™‚çš„èªªæ˜
        window.onload = function() {
            console.log('ğŸš€ æœƒå“¡å¡å•Ÿç”¨åŠŸèƒ½æ¸¬è©¦é é¢å·²è¼‰å…¥');
            console.log('è«‹ç¢ºä¿é–‹ç™¼ä¼ºæœå™¨æ­£åœ¨é‹è¡Œ (npm run dev)');
        };
    </script>
</body>
</html>