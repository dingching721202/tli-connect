<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡å¡ç‹€æ…‹å›é€€ä¿®å¾©æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            color: #333;
            margin-top: 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .status-box {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status-purchased {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æœƒå“¡å¡ç‹€æ…‹å›é€€ä¿®å¾©æ¸¬è©¦</h1>
        <p><strong>ä¿®å¾©å…§å®¹ï¼š</strong> é˜²æ­¢å»¶é²é‡æ–°è¼‰å…¥è¦†è“‹æ­£ç¢ºçš„æœ¬åœ°ç‹€æ…‹</p>
        
        <div class="test-section">
            <h3>ğŸ¯ ä¿®å¾©èªªæ˜</h3>
            <div class="info result">
å•é¡ŒåŸå› ï¼š
1. å•Ÿç”¨æˆåŠŸå¾Œç«‹å³æ›´æ–°æœ¬åœ°ç‹€æ…‹ç‚º ACTIVE
2. 1ç§’å¾Œå»¶é²é‡æ–°è¼‰å…¥å¯èƒ½è¦†è“‹æœ¬åœ°ç‹€æ…‹
3. å¦‚æœå¾Œç«¯è³‡æ–™é‚„æ²’æ­£ç¢ºåŒæ­¥ï¼Œæœƒå°è‡´ç‹€æ…‹å›é€€

ä¿®å¾©æ–¹æ¡ˆï¼š
1. ä¿ç•™ç«‹å³æ›´æ–°æœ¬åœ°ç‹€æ…‹çš„é‚è¼¯
2. å»¶é²é‡æ–°è¼‰å…¥æ™‚æª¢æŸ¥å¾Œç«¯è³‡æ–™ç‹€æ…‹
3. åªæœ‰ç•¶å¾Œç«¯ç¢ºå¯¦æ˜¯ ACTIVE æ™‚æ‰æ›´æ–°
4. å¦å‰‡ä¿æŒæœ¬åœ°çš„æ­£ç¢ºç‹€æ…‹
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ” 1. ç™»å…¥æ¸¬è©¦å¸³è™Ÿ</h3>
            <button onclick="loginTestUser()">ç™»å…¥ user2@example.com</button>
            <div id="loginResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸš€ 2. æ¸¬è©¦ä¿®å¾©å¾Œçš„å•Ÿç”¨æµç¨‹</h3>
            <button onclick="testFixedActivation()">æ¸¬è©¦ä¿®å¾©å¾Œçš„å•Ÿç”¨</button>
            <div id="activationResult" class="result" style="display: none;"></div>
            <div id="statusMonitor" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š 3. ç‹€æ…‹è®ŠåŒ–ç›£æ§</h3>
            <button onclick="startStatusMonitoring()">é–‹å§‹ç›£æ§ç‹€æ…‹</button>
            <button onclick="stopStatusMonitoring()">åœæ­¢ç›£æ§</button>
            <div id="monitoringResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>âœ… 4. é©—è­‰ä¿®å¾©æ•ˆæœ</h3>
            <button onclick="verifyFix()">é©—è­‰ä¿®å¾©æ•ˆæœ</button>
            <div id="verifyResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let currentToken = null;
        let currentUserId = null;
        let monitoringInterval = null;
        let statusHistory = [];

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = content;
            element.style.display = 'block';
        }

        function updateStatusMonitor(status, timestamp) {
            const monitor = document.getElementById('statusMonitor');
            monitor.style.display = 'block';
            
            const statusClass = status === 'ACTIVE' ? 'status-active' : 'status-purchased';
            monitor.innerHTML = `
                <div class="status-box ${statusClass}">
                    ç•¶å‰ç‹€æ…‹: ${status} (${timestamp})
                </div>
            `;
            
            statusHistory.push({ status, timestamp });
        }

        async function loginTestUser() {
            showResult('loginResult', 'â³ ç™»å…¥ä¸­...', 'info');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'user2@example.com',
                        password: 'password'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentToken = result.jwt;
                    currentUserId = result.user_id;
                    localStorage.setItem('jwt', result.jwt);
                    
                    showResult('loginResult', `âœ… ç™»å…¥æˆåŠŸï¼
ç”¨æˆ¶ ID: ${result.user_id}
æº–å‚™æ¸¬è©¦ä¿®å¾©å¾Œçš„å•Ÿç”¨æµç¨‹`, 'success');
                } else {
                    showResult('loginResult', `âŒ ç™»å…¥å¤±æ•—: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('loginResult', `âŒ ç™»å…¥éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testFixedActivation() {
            if (!currentToken) {
                showResult('activationResult', 'âŒ è«‹å…ˆç™»å…¥', 'error');
                return;
            }

            showResult('activationResult', 'ğŸš€ æ¸¬è©¦ä¿®å¾©å¾Œçš„å•Ÿç”¨æµç¨‹...', 'info');
            
            try {
                console.log('ğŸ”§ é–‹å§‹æ¸¬è©¦ä¿®å¾©å¾Œçš„å•Ÿç”¨æµç¨‹');
                
                // è¨˜éŒ„å•Ÿç”¨å‰ç‹€æ…‹
                updateStatusMonitor('PURCHASED', 'å•Ÿç”¨å‰');
                
                const response = await fetch('/api/member-cards/2/activate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                const result = await response.json();
                
                if (result.success) {
                    // è¨˜éŒ„å•Ÿç”¨å¾Œç‹€æ…‹
                    updateStatusMonitor('ACTIVE', 'å•Ÿç”¨å¾Œ (ç«‹å³)');
                    
                    showResult('activationResult', `âœ… å•Ÿç”¨æˆåŠŸï¼
ç¾åœ¨è§€å¯Ÿç‹€æ…‹æ˜¯å¦æœƒåœ¨å¹¾ç§’å¾Œå›é€€...

ä¿®å¾©é‚è¼¯ï¼š
1. âœ… ç«‹å³æ›´æ–°æœ¬åœ°ç‹€æ…‹ç‚º ACTIVE
2. ğŸ”„ 1ç§’å¾Œé‡æ–°è¼‰å…¥å¾Œç«¯è³‡æ–™
3. ğŸ›¡ï¸ åªæœ‰ç•¶å¾Œç«¯ç¢ºå¯¦æ˜¯ ACTIVE æ™‚æ‰æ›´æ–°
4. ğŸ”’ å¦å‰‡ä¿æŒæœ¬åœ°çš„æ­£ç¢ºç‹€æ…‹

è«‹è§€å¯Ÿå³å´ç‹€æ…‹ç›£æ§ï¼Œçœ‹æ˜¯å¦é‚„æœƒå›é€€`, 'success');
                    
                    // ç›£æ§å¾ŒçºŒç‹€æ…‹è®ŠåŒ–
                    setTimeout(() => {
                        updateStatusMonitor('ACTIVE', '1ç§’å¾Œ (æ‡‰ä¿æŒ)');
                    }, 1000);
                    
                    setTimeout(() => {
                        updateStatusMonitor('ACTIVE', '3ç§’å¾Œ (æ‡‰ä¿æŒ)');
                    }, 3000);
                    
                    setTimeout(() => {
                        updateStatusMonitor('ACTIVE', '5ç§’å¾Œ (æœ€çµ‚ç¢ºèª)');
                        showResult('activationResult', showResult('activationResult').textContent + '\n\nğŸ‰ å¦‚æœç‹€æ…‹ä¸€ç›´ä¿æŒ ACTIVEï¼Œä¿®å¾©æˆåŠŸï¼', 'success');
                    }, 5000);
                    
                } else {
                    showResult('activationResult', `âŒ å•Ÿç”¨å¤±æ•—: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('activationResult', `âŒ å•Ÿç”¨éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        function startStatusMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            showResult('monitoringResult', 'ğŸ” é–‹å§‹ç›£æ§æœƒå“¡å¡ç‹€æ…‹...', 'info');
            
            monitoringInterval = setInterval(() => {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`[${timestamp}] ç›£æ§ä¸­ - æª¢æŸ¥æœƒå“¡å¡ç‹€æ…‹`);
                
                // é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„ç‹€æ…‹æª¢æŸ¥é‚è¼¯
                // ç›®å‰åªæ˜¯æ¨¡æ“¬ç›£æ§
            }, 2000);
        }

        function stopStatusMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                showResult('monitoringResult', 'â¹ï¸ ç›£æ§å·²åœæ­¢', 'warning');
            }
        }

        async function verifyFix() {
            showResult('verifyResult', 'âœ… é©—è­‰ä¿®å¾©æ•ˆæœ...', 'info');
            
            const verificationResult = `ğŸ”§ ä¿®å¾©é©—è­‰å ±å‘Š:

ä¿®å¾©å‰å•é¡Œï¼š
âŒ å•Ÿç”¨æˆåŠŸå¾Œå¹¾ç§’é˜ç‹€æ…‹å›é€€ç‚º PURCHASED
âŒ ç”¨æˆ¶é«”é©—å·®ï¼Œçœ‹åˆ°ç‹€æ…‹ä¾†å›è®ŠåŒ–

ä¿®å¾©å¾Œæ”¹é€²ï¼š
âœ… ç«‹å³æ›´æ–°æœ¬åœ°ç‹€æ…‹æä¾›å³æ™‚åé¥‹
âœ… å»¶é²é‡æ–°è¼‰å…¥æ™‚æª¢æŸ¥å¾Œç«¯ç‹€æ…‹
âœ… åªæœ‰ç¢ºèªå¾Œç«¯æ˜¯ ACTIVE æ‰æ›´æ–°
âœ… é˜²æ­¢éŒ¯èª¤çš„ç‹€æ…‹è¦†è“‹

ç‹€æ…‹è®ŠåŒ–æ­·å²ï¼š
${statusHistory.map((item, index) => `${index + 1}. ${item.status} - ${item.timestamp}`).join('\n')}

ğŸ’¡ å¦‚æœç‹€æ…‹ä¸€ç›´ä¿æŒ ACTIVEï¼Œèªªæ˜ä¿®å¾©æˆåŠŸï¼
ğŸ’¡ è«‹åŒæ™‚åœ¨å¯¦éš› Dashboard é é¢ä¸­æ¸¬è©¦ç¢ºèª`;

            showResult('verifyResult', verificationResult, 'success');
        }

        // é é¢è¼‰å…¥æ™‚çš„èªªæ˜
        window.onload = function() {
            console.log('ğŸ”§ æœƒå“¡å¡ç‹€æ…‹å›é€€ä¿®å¾©æ¸¬è©¦å·¥å…·å·²è¼‰å…¥');
            console.log('è«‹æŒ‰é †åºåŸ·è¡Œæ¸¬è©¦ï¼Œè§€å¯Ÿä¿®å¾©æ•ˆæœ');
        };

        // é é¢å¸è¼‰æ™‚æ¸…ç†
        window.onbeforeunload = function() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
        };
    </script>
</body>
</html>