<!DOCTYPE html>
<html>
<head>
    <title>調試當前課程連結邏輯</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { border: 1px solid #ccc; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #ffe8e8; border-color: #f44336; }
        .code { background: #f5f5f5; padding: 10px; border-radius: 3px; font-family: monospace; }
        pre { margin: 5px 0; }
    </style>
</head>
<body>
    <h1>🔍 調試當前課程連結邏輯</h1>
    
    <div id="results"></div>
    
    <script>
        // 模擬課程模板數據
        const mockTemplate = {
            id: 'template_pronunciation',
            title: 'Pronunciation',
            globalSettings: {
                defaultVirtualClassroomLink: 'https://meet.google.com/global-classroom',
                defaultMaterialLink: 'https://drive.google.com/global-materials'
            },
            sessions: [
                {
                    sessionNumber: 1,
                    title: 'Lesson 1',
                    virtualClassroomLink: 'https://meet.google.com/lesson-1-room',
                    materialLink: 'https://drive.google.com/lesson-1-materials'
                },
                {
                    sessionNumber: 2,
                    title: 'Lesson 2',
                    virtualClassroomLink: '', // 空的，應該使用統一設定
                    materialLink: '' // 空的，應該使用統一設定
                },
                {
                    sessionNumber: 3,
                    title: 'Lesson 3',
                    virtualClassroomLink: 'https://meet.google.com/lesson-3-room',
                    materialLink: '' // 空的，應該使用統一設定
                }
            ]
        };

        const templates = [mockTemplate];

        // 模擬 getCourseTemplates
        function getCourseTemplates() {
            return templates;
        }

        // 模擬 isValidLink
        function isValidLink(link) {
            if (!link || link.trim() === '') return false;
            
            const placeholderLinks = [
                'https://meet.google.com/course-session',
                'https://example.com/classroom',
                'https://placeholder.com',
                'https://your-classroom-link.com',
                'https://your-material-link.com'
            ];
            
            if (placeholderLinks.includes(link.trim())) {
                return false;
            }
            
            try {
                if (link.startsWith('http://') || link.startsWith('https://')) {
                    new URL(link);
                    return true;
                }
                return false;
            } catch {
                return false;
            }
        }

        // 模擬 getCourseLinksFromTemplate
        function getCourseLinksFromTemplate(courseName, lessonNumber) {
            console.log(`🔍 查找課程連結: ${courseName} - Lesson ${lessonNumber}`);
            
            // 1. 查找課程模板
            const courseTemplate = templates.find(template => {
                const templateTitle = template.title.toLowerCase();
                const searchName = courseName.toLowerCase();
                
                if (templateTitle === searchName) return true;
                if (templateTitle.includes(searchName) || searchName.includes(templateTitle)) return true;
                
                const normalizedTemplate = templateTitle.replace(/\\s+/g, '');
                const normalizedSearch = searchName.replace(/\\s+/g, '');
                if (normalizedTemplate === normalizedSearch) return true;
                
                return false;
            });
            
            if (!courseTemplate) {
                console.warn(`❌ 未找到課程模板: ${courseName}`);
                return { classroom: null, materials: null };
            }
            
            console.log(`✅ 找到課程模板: ${courseTemplate.title}`);
            
            // 2. 查找對應的 Session
            const session = courseTemplate.sessions.find(s => s.sessionNumber === lessonNumber);
            
            if (!session) {
                console.warn(`❌ 在課程 ${courseTemplate.title} 中未找到 Lesson ${lessonNumber}`);
                return { classroom: null, materials: null };
            }
            
            console.log(`✅ 找到課程Session: Lesson ${session.sessionNumber} - ${session.title}`);
            
            // 3. 獲取連結，個別連結為空時使用統一設定
            let classroom = session.virtualClassroomLink;
            let materials = session.materialLink;
            
            // 如果個別連結為空，使用統一設定
            if (!classroom || classroom.trim() === '') {
                classroom = courseTemplate.globalSettings?.defaultVirtualClassroomLink || null;
                if (classroom) {
                    console.log(`📍 使用統一教室設定: ${classroom}`);
                }
            } else {
                console.log(`📍 使用個別教室設定: ${classroom}`);
            }
            
            if (!materials || materials.trim() === '') {
                materials = courseTemplate.globalSettings?.defaultMaterialLink || null;
                if (materials) {
                    console.log(`📄 使用統一教材設定: ${materials}`);
                }
            } else {
                console.log(`📄 使用個別教材設定: ${materials}`);
            }
            
            console.log(`🔗 最終連結:`, {
                classroom: classroom || '無',
                materials: materials || '無'
            });
            
            return {
                classroom: classroom || null,
                materials: materials || null
            };
        }

        // 模擬 getCourseLinksForLesson
        function getCourseLinksForLesson(courseName, lessonNumber) {
            const links = getCourseLinksFromTemplate(courseName, lessonNumber);
            
            return {
                classroom: isValidLink(links.classroom) ? links.classroom : null,
                materials: isValidLink(links.materials) ? links.materials : null,
                hasValidClassroom: isValidLink(links.classroom),
                hasValidMaterials: isValidLink(links.materials)
            };
        }

        // 測試案例
        const testCases = [
            {
                description: 'Lesson 1 - 有個別連結',
                courseName: 'Pronunciation',
                lessonNumber: 1,
                expected: {
                    hasValidClassroom: true,
                    hasValidMaterials: true,
                    classroom: 'https://meet.google.com/lesson-1-room',
                    materials: 'https://drive.google.com/lesson-1-materials'
                }
            },
            {
                description: 'Lesson 2 - 個別連結為空，應使用統一設定',
                courseName: 'Pronunciation',
                lessonNumber: 2,
                expected: {
                    hasValidClassroom: true,
                    hasValidMaterials: true,
                    classroom: 'https://meet.google.com/global-classroom',
                    materials: 'https://drive.google.com/global-materials'
                }
            },
            {
                description: 'Lesson 3 - 混合情況（教室有個別，教材用統一）',
                courseName: 'Pronunciation',
                lessonNumber: 3,
                expected: {
                    hasValidClassroom: true,
                    hasValidMaterials: true,
                    classroom: 'https://meet.google.com/lesson-3-room',
                    materials: 'https://drive.google.com/global-materials'
                }
            }
        ];

        const results = document.getElementById('results');
        let allPassed = true;

        testCases.forEach((testCase, index) => {
            console.log(`\\n=== 測試案例 ${index + 1}: ${testCase.description} ===`);
            
            const result = getCourseLinksForLesson(testCase.courseName, testCase.lessonNumber);
            
            const classroomMatch = result.classroom === testCase.expected.classroom;
            const materialsMatch = result.materials === testCase.expected.materials;
            const hasClassroomMatch = result.hasValidClassroom === testCase.expected.hasValidClassroom;
            const hasMaterialsMatch = result.hasValidMaterials === testCase.expected.hasValidMaterials;
            
            const passed = classroomMatch && materialsMatch && hasClassroomMatch && hasMaterialsMatch;
            allPassed = allPassed && passed;
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `test ${passed ? 'success' : 'error'}`;
            
            resultDiv.innerHTML = `
                <h3>${testCase.description}</h3>
                <p><strong>課程:</strong> ${testCase.courseName} - Lesson ${testCase.lessonNumber}</p>
                
                <h4>教室連結:</h4>
                <div class="code">
預期: ${testCase.expected.classroom || 'null'}
實際: ${result.classroom || 'null'}
有效: ${result.hasValidClassroom} (預期: ${testCase.expected.hasValidClassroom})
匹配: ${classroomMatch ? '✅' : '❌'}
                </div>
                
                <h4>教材連結:</h4>
                <div class="code">
預期: ${testCase.expected.materials || 'null'}
實際: ${result.materials || 'null'}
有效: ${result.hasValidMaterials} (預期: ${testCase.expected.hasValidMaterials})
匹配: ${materialsMatch ? '✅' : '❌'}
                </div>
                
                <p style="color: ${passed ? 'green' : 'red'}; font-weight: bold;">
                    ${passed ? '✅ 通過' : '❌ 失敗'}
                </p>
            `;
            
            results.appendChild(resultDiv);
        });

        // 總結
        const summary = document.createElement('div');
        summary.className = `test ${allPassed ? 'success' : 'error'}`;
        summary.innerHTML = `
            <h2>測試總結</h2>
            <p>總共 ${testCases.length} 個測試案例</p>
            <p style="color: ${allPassed ? 'green' : 'red'}; font-weight: bold;">
                ${allPassed ? '🎉 所有測試通過！邏輯運作正常。' : '❌ 有測試失敗，需要檢查實作。'}
            </p>
            
            <h3>邏輯驗證：</h3>
            <div class="code">
1. ✅ 能正確根據課程名稱找到課程模板
2. ✅ 能正確根據 Lesson 編號找到對應的 Session
3. ✅ 當個別連結存在時使用個別連結
4. ✅ 當個別連結為空時使用統一設定連結
5. ✅ 混合情況處理正確（部分個別，部分統一）
            </div>
        `;
        
        results.insertBefore(summary, results.firstChild);
    </script>
</body>
</html>